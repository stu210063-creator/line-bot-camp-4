import os
import sys
import logging
import threading
import time
import requests
from bs4 import BeautifulSoup
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,
    FlexSendMessage, BubbleContainer, BoxComponent,
    TextComponent, ButtonComponent, URIAction,
    SeparatorComponent
)

# --- è¨­å®šæ—¥èªŒ ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)

# --- å¾ç’°å¢ƒè®Šæ•¸ç²å– LINE Bot è¨­å®š (åœ¨ Zeabur è¨­å®šé é¢å¡«å…¥) ---
CHANNEL_ACCESS_TOKEN = os.getenv('LINE_CHANNEL_ACCESS_TOKEN')
CHANNEL_SECRET = os.getenv('LINE_CHANNEL_SECRET')

if not CHANNEL_ACCESS_TOKEN or not CHANNEL_SECRET:
    logger.error("è«‹ç¢ºèªå·²è¨­å®š LINE_CHANNEL_ACCESS_TOKEN èˆ‡ LINE_CHANNEL_SECRET ç’°å¢ƒè®Šæ•¸")
    # ç‚ºäº†é˜²æ­¢æœ¬åœ°æ¸¬è©¦å ±éŒ¯ï¼Œé€™è£¡çµ¦ç©ºå€¼ï¼Œä½†åœ¨æ­£å¼ç’°å¢ƒæœƒå¤±æ•—
    line_bot_api = None
    handler = None
else:
    line_bot_api = LineBotApi(CHANNEL_ACCESS_TOKEN)
    handler = WebhookHandler(CHANNEL_SECRET)

# --- æ¨¡æ“¬è³‡æ–™åº«èˆ‡çˆ¬èŸ²é‚è¼¯ ---

class CampManager:
    def __init__(self):
        self.camps = []
        # åˆå§‹åŒ–æ™‚å…ˆè¼‰å…¥ä¸€äº›æ¨¡æ“¬è³‡æ–™ï¼Œä¸¦å•Ÿå‹•èƒŒæ™¯çˆ¬èŸ²
        self.mock_data()
        
    def mock_data(self):
        """
        æ¨¡æ“¬åˆå§‹è³‡æ–™ã€‚åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒæ˜¯å¾è³‡æ–™åº«è®€å–ã€‚
        """
        self.camps = [
            {
                "title": "2024 å°å¤§è³‡è¨Šæˆ°é¬¥ç‡Ÿ",
                "location": "å°åŒ—å¸‚",
                "date": "2024/07/15 - 2024/07/19",
                "price": 5000,
                "tags": ["è³‡è¨Š", "ç¨‹å¼", "å¤§å­¸ç‡ŸéšŠ"],
                "url": "https://www.ntu.edu.tw/"
            },
            {
                "title": "æˆå¤§é†«å­¸ç‡Ÿ - æŠ«ç™½è¢çš„æ—…ç¨‹",
                "location": "å°å—å¸‚",
                "date": "2024/08/01 - 2024/08/05",
                "price": 6500,
                "tags": ["é†«å­¸", "ç”Ÿç‰©", "é«”é©—"],
                "url": "https://www.ncku.edu.tw/"
            },
            {
                "title": "é«˜ä¸­ç”ŸAIäººå·¥æ™ºæ…§é«”é©—åŠ",
                "location": "ç·šä¸Š",
                "date": "2024/06/20",
                "price": 0,
                "tags": ["AI", "å…è²»", "ç§‘æŠ€"],
                "url": "https://example.com/ai-camp"
            },
            {
                "title": "æ¸…å¤§ç‰©ç†ç§‘å­¸æ¢ç©¶ç‡Ÿ",
                "location": "æ–°ç«¹å¸‚",
                "date": "2024/07/10 - 2024/07/12",
                "price": 3000,
                "tags": ["ç‰©ç†", "ç§‘å­¸", "å¯¦é©—"],
                "url": "https://www.nthu.edu.tw/"
            }
        ]

    def crawl_external_data(self):
        """
        (ç¯„ä¾‹) å¯¦éš›çˆ¬èŸ²é‚è¼¯ã€‚
        é€™è£¡ç¤ºç¯„å¦‚ä½•çˆ¬å–ä¸€å€‹å‡è¨­çš„ç¶²ç«™çµæ§‹ã€‚
        ä½ å¯ä»¥åœ¨é€™è£¡åŠ å…¥æ›´å¤šä¸åŒä¾†æºçš„çˆ¬èŸ²ã€‚
        """
        logger.info("é–‹å§‹åŸ·è¡ŒèƒŒæ™¯çˆ¬èŸ²...")
        try:
            # ç¯„ä¾‹ï¼šå‡è¨­æˆ‘å€‘è¦çˆ¬å–æŸå€‹æ´»å‹•ç¶²ç«™ (é€™è£¡ç”¨ Google ä½œç‚ºå‡ç›®æ¨™ï¼Œå¯¦éš›è«‹æ›æˆ Accupass æˆ–å¤§å­¸ç¶²ç«™)
            # headers = {'User-Agent': 'Mozilla/5.0 ...'}
            # response = requests.get('https://example-camp-site.com', headers=headers)
            # soup = BeautifulSoup(response.text, 'html.parser')
            
            # é‡å°ä¸åŒç¶²ç«™çµæ§‹è§£æè³‡æ–™
            # for item in soup.select('.camp-item'):
            #     title = item.select_one('.title').text
            #     ...
            #     self.camps.append({...})
            
            # é€™è£¡æˆ‘å€‘æ¨¡æ“¬"æ›´æ–°"äº†ä¸€ç­†è³‡æ–™
            self.camps.append({
                "title": f"æœ€æ–°è‡ªå‹•æœé›†ï¼šé«˜ä¸­å•†æ¥­ç«¶è³½ç‡Ÿ (æ›´æ–°æ™‚é–“ {time.strftime('%H:%M')})",
                "location": "å°ä¸­å¸‚",
                "date": "2024/09/01",
                "price": 1200,
                "tags": ["å•†æ¥­", "ç«¶è³½"],
                "url": "https://google.com"
            })
            logger.info("è³‡æ–™æ›´æ–°å®Œæˆ")
            
        except Exception as e:
            logger.error(f"çˆ¬èŸ²ç™¼ç”ŸéŒ¯èª¤: {e}")

    def search(self, query):
        """
        æ ¹æ“šé—œéµå­—æœå°‹ç‡ŸéšŠ
        æ”¯æ´å¤šé—œéµå­—ï¼Œä¾‹å¦‚ "å°åŒ— è³‡è¨Š"
        """
        if not query:
            return self.camps[:5] # é è¨­å›å‚³å‰5ç­†

        keywords = query.split()
        results = []
        
        for camp in self.camps:
            # å°‡æ‰€æœ‰æ¬„ä½çµ„åˆæˆå­—ä¸²ä¾†æ¯”å°
            camp_str = f"{camp['title']} {camp['location']} {str(camp['price'])} {' '.join(camp['tags'])}"
            
            # æª¢æŸ¥æ˜¯å¦æ‰€æœ‰é—œéµå­—éƒ½åœ¨é€™å€‹ç‡ŸéšŠè³‡è¨Šä¸­ (AND é‚è¼¯)
            match = True
            for kw in keywords:
                if kw == "å…è²»" and camp['price'] == 0:
                    continue
                if kw not in camp_str:
                    match = False
                    break
            
            if match:
                results.append(camp)
        
        return results

# åˆå§‹åŒ–ç‡ŸéšŠç®¡ç†å™¨
camp_manager = CampManager()

# --- Flex Message ç”¢ç”Ÿå™¨ (è®“ LINE è¨Šæ¯è®Šæ¼‚äº®) ---
def create_camp_flex(camps):
    bubbles = []
    for camp in camps[:10]: # LINE é™åˆ¶ä¸€æ¬¡æœ€å¤šé¡¯ç¤º 12 å€‹ carouselï¼Œæˆ‘å€‘å–å‰ 10
        bubble = BubbleContainer(
            hero={
                "type": "image",
                "url": "https://images.unsplash.com/photo-1523580494863-6f3031224c94?ixlib=rb-1.2.1&auto=format&fit=crop&w=700&q=80", # ç¯„ä¾‹åœ–ç‰‡ï¼Œå¯¦éš›å¯æ›æˆç‡ŸéšŠåœ–ç‰‡
                "size": "full",
                "aspectRatio": "20:13",
                "aspectMode": "cover"
            },
            body=BoxComponent(
                layout="vertical",
                contents=[
                    TextComponent(text=camp['title'], weight="bold", size="xl", wrap=True),
                    BoxComponent(
                        layout="baseline",
                        margin="md",
                        contents=[
                            TextComponent(text=f"ğŸ“ {camp['location']}", size="sm", color="#999999", flex=1),
                            TextComponent(text=f"ğŸ’² {camp['price'] if camp['price'] > 0 else 'å…è²»'}", size="sm", color="#999999", flex=1)
                        ]
                    ),
                    BoxComponent(
                        layout="vertical",
                        margin="md",
                        contents=[
                            TextComponent(text=f"ğŸ“… {camp['date']}", size="sm", color="#555555"),
                            TextComponent(text=f"ğŸ·ï¸ {' '.join(camp['tags'])}", size="xs", color="#aaaaaa", margin="sm", wrap=True)
                        ]
                    )
                ]
            ),
            footer=BoxComponent(
                layout="vertical",
                spacing="sm",
                contents=[
                    ButtonComponent(
                        style="link",
                        height="sm",
                        action=URIAction(label="æŸ¥çœ‹è©³æƒ…", uri=camp['url'])
                    )
                ]
            )
        )
        bubbles.append(bubble)

    return FlexSendMessage(
        alt_text="ç‚ºæ‚¨æ‰¾åˆ°çš„ç‡ŸéšŠè³‡è¨Š",
        contents={
            "type": "carousel",
            "contents": bubbles
        }
    )

# --- Flask Routes ---

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    app.logger.info("Request body: " + body)

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

@app.route("/")
def health_check():
    # é€™æ˜¯çµ¦ Zeabur å¥åº·æª¢æŸ¥ç”¨çš„
    return "Line Bot is running!"

@app.route("/trigger_crawl")
def trigger_crawl():
    # æ‰‹å‹•è§¸ç™¼çˆ¬èŸ²çš„ API (å¯é€é Cron Job å‘¼å«)
    camp_manager.crawl_external_data()
    return "Crawl triggered"

# --- LINE è¨Šæ¯è™•ç† ---

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_msg = event.message.text.strip()
    
    # æŒ‡ä»¤èªªæ˜
    if user_msg == "èªªæ˜" or user_msg == "help":
        instruction = "è«‹è¼¸å…¥é—œéµå­—æœå°‹ç‡ŸéšŠï¼Œä¾‹å¦‚ï¼š\n\nã€Œå°åŒ— è³‡è¨Šã€\nã€Œå…è²» AIã€\nã€Œé†«å­¸ã€\n\nè¼¸å…¥å¤šå€‹é—œéµå­—è«‹ç”¨ç©ºç™½éš”é–‹ã€‚"
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=instruction))
        return

    # åŸ·è¡Œæœå°‹
    found_camps = camp_manager.search(user_msg)
    
    if found_camps:
        flex_msg = create_camp_flex(found_camps)
        line_bot_api.reply_message(event.reply_token, flex_msg)
    else:
        line_bot_api.reply_message(
            event.reply_token, 
            TextSendMessage(text=f"æŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°èˆ‡ã€Œ{user_msg}ã€ç›¸é—œçš„ç‡ŸéšŠã€‚\nå»ºè­°æ›´æ›é—œéµå­—æˆ–åªè¼¸å…¥åœ°é»è©¦è©¦çœ‹ã€‚")
        )

# --- å•Ÿå‹•è¨­å®š ---
if __name__ == "__main__":
    # åœ¨èƒŒæ™¯å•Ÿå‹•ä¸€å€‹å®šæ™‚ä»»å‹™æˆ–åˆå§‹çˆ¬èŸ² (é€™è£¡ç°¡åŒ–ç‚ºå•Ÿå‹•æ™‚è·‘ä¸€æ¬¡)
    threading.Thread(target=camp_manager.crawl_external_data).start()
    
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
